#!/usr/bin/env bash
#
# Sync Pi-hole data and secrets from this NixOS host to Orange Pi
#
# Usage: sync-to-orangepi [orangepi-host]
#        sync-to-orangepi 192.168.254.5
#        sync-to-orangepi  # Uses default

set -euo pipefail

# Configuration
ORANGEPI_HOST="${1:-192.168.254.5}"
ORANGEPI_USER="${ORANGEPI_USER:-root}"
ORANGEPI_IP="192.168.254.5"  # Orange Pi's own IP for local-domain config

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m'

log() { echo -e "${GREEN}[+]${NC} $1"; }
warn() { echo -e "${YELLOW}[!]${NC} $1"; }
error() { echo -e "${RED}[-]${NC} $1"; exit 1; }

# Create temp directory
TMPDIR=$(mktemp -d)
trap "rm -rf $TMPDIR" EXIT

log "Syncing to Orange Pi ($ORANGEPI_HOST)"

# ============================================================================
# 1. FETCH SECRETS (already decrypted at runtime)
# ============================================================================
log "Reading secrets..."

# Get domain secret
DOMAIN=""
if [ -f /run/secrets/domain ]; then
    DOMAIN=$(cat /run/secrets/domain)
    log "Domain: $DOMAIN"
    
    # Generate unbound local-domain config
    cat > "$TMPDIR/local-domain.conf" << EOF
# Auto-generated by sync-to-orangepi
# Routes local.$DOMAIN to Orange Pi

server:
    local-zone: "local.$DOMAIN." redirect
    local-data: "local.$DOMAIN. 3600 IN A $ORANGEPI_IP"
EOF
    log "Generated local-domain.conf"
else
    warn "Domain secret not found at /run/secrets/domain"
fi

# Get custom hosts
if [ -f /run/secrets/hosts ]; then
    cp /run/secrets/hosts "$TMPDIR/custom-hosts"
    log "Copied custom hosts"
elif [ -f /etc/dnsmasq.d/custom-hosts ]; then
    cp /etc/dnsmasq.d/custom-hosts "$TMPDIR/custom-hosts"
    log "Copied custom hosts from /etc/dnsmasq.d/"
else
    warn "No custom hosts found"
fi

# ============================================================================
# 2. FETCH PI-HOLE DATA
# ============================================================================
log "Fetching Pi-hole databases..."

tar czf "$TMPDIR/pihole.tar.gz" \
    -C / \
    var/lib/pihole/gravity.db \
    var/lib/pihole/pihole-FTL.db \
    2>/dev/null || warn "Some Pi-hole files may be missing"

# ============================================================================
# 3. UPLOAD TO ORANGE PI
# ============================================================================
log "Uploading to Orange Pi..."

# Upload pihole data
scp "$TMPDIR/pihole.tar.gz" "${ORANGEPI_USER}@${ORANGEPI_HOST}:/tmp/"

# Upload unbound local-domain config if we have it
[ -f "$TMPDIR/local-domain.conf" ] && scp "$TMPDIR/local-domain.conf" "${ORANGEPI_USER}@${ORANGEPI_HOST}:/tmp/"

# Upload custom hosts if we have it
[ -f "$TMPDIR/custom-hosts" ] && scp "$TMPDIR/custom-hosts" "${ORANGEPI_USER}@${ORANGEPI_HOST}:/tmp/"

# ============================================================================
# 4. INSTALL FILES ON ORANGE PI
# ============================================================================
log "Installing files on Orange Pi..."

ssh "${ORANGEPI_USER}@${ORANGEPI_HOST}" << 'REMOTE_SCRIPT'
set -e
cd /tmp

# Stop services during sync
systemctl stop pihole-FTL 2>/dev/null || true

# --- Pi-hole databases ---
if [ -f pihole.tar.gz ]; then
    tar xzf pihole.tar.gz 2>/dev/null || true
    [ -f var/lib/pihole/gravity.db ] && cp var/lib/pihole/gravity.db /etc/pihole/
    [ -f var/lib/pihole/pihole-FTL.db ] && cp var/lib/pihole/pihole-FTL.db /etc/pihole/
    chown pihole:pihole /etc/pihole/*.db 2>/dev/null || true
    echo "  ✓ Pi-hole databases installed"
fi

# --- Unbound local-domain config ---
if [ -f local-domain.conf ]; then
    cp local-domain.conf /etc/unbound/unbound.conf.d/local-domain.conf
    if unbound-checkconf > /dev/null 2>&1; then
        systemctl restart unbound
        echo "  ✓ Unbound local-domain.conf installed"
    else
        echo "  ✗ Unbound config error - check /etc/unbound/unbound.conf.d/local-domain.conf"
    fi
fi

# --- Custom hosts for dnsmasq/pihole ---
if [ -f custom-hosts ]; then
    cp custom-hosts /etc/dnsmasq.d/custom-hosts
    echo "  ✓ Custom hosts installed"
fi

# Cleanup
rm -rf /tmp/pihole.tar.gz /tmp/var /tmp/etc /tmp/local-domain.conf /tmp/custom-hosts 2>/dev/null || true

# Start pihole
systemctl start pihole-FTL

echo ""
echo "Sync complete!"
REMOTE_SCRIPT

log "Sync complete!"

echo ""
echo "Verify on Orange Pi:"
echo "  dig @localhost google.com"
if [ -n "$DOMAIN" ]; then
    echo "  dig @localhost local.$DOMAIN"
fi

